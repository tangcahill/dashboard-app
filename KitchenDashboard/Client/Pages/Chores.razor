@page "/chores"
@using MudBlazor
@inject NavigationManager NavigationManager
@inject ChoreService ChoreService

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudStack Row AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h4">Chores Manager</MudText>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Home"
                       Color="Color.Primary"
                       OnClick='@(() => NavigationManager.NavigateTo("/"))' />
    </MudStack>

    <MudStack Spacing="2" Class="my-4">
        <MudButton Variant="Variant.Outlined"
                   FullWidth="true"
                   StartIcon="@Icons.Material.Filled.Checklist"
                   OnClick="() => ShowView(ViewType.Active)">
            Today's Chores
        </MudButton>
        <MudButton Variant="Variant.Outlined"
                   FullWidth="true"
                   StartIcon="@Icons.Material.Filled.AddBox"
                   OnClick="() => ShowView(ViewType.Add)">
            Add Chore
        </MudButton>
        <MudButton Variant="Variant.Outlined"
                   FullWidth="true"
                   StartIcon="@Icons.Material.Filled.List"
                   OnClick="() => ShowView(ViewType.List)">
            List Chores
        </MudButton>
    </MudStack>

    @if (currentView == ViewType.Active)
    {
        @if (!RecurringChores.Any() && !OneOffChores.Any())
        {
            <MudText Typo="Typo.h6" Align="Align.Center">No chores to do!</MudText>
        }
        else
        {
            <MudGrid Spacing="2">
                @foreach (var c in RecurringChores)
                {
                    <MudItem xs="12" sm="6">
                        <MudCard Class="pa-2 mb-2">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.h6"
                                         Class="flex-grow-1 clickable"
                                         OnClick="() => CompleteRecurring(c.Id)">
                                    @c.Description
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Color="Color.Info"
                                               OnClick="() => UpdateRecurring(c.Id)" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error"
                                               OnClick="() => DeleteRecurring(c.Id)" />
                            </MudStack>
                        </MudCard>
                    </MudItem>
                }
                @foreach (var o in OneOffChores)
                {
                    <MudItem xs="12" sm="6">
                        <MudCard Class="pa-2 mb-2">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.h6"
                                         Class="flex-grow-1 clickable"
                                         OnClick="() => CompleteOneOff(o.Id)">
                                    @o.Description
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Color="Color.Info"
                                               OnClick="() => UpdateOneOff(o.Id)" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error"
                                               OnClick="() => DeleteOneOff(o.Id)" />
                            </MudStack>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
    }
    else if (currentView == ViewType.Add)
    {
        <MudDivider Class="my-4" />

        <MudPaper Class="pa-4" Elevation="0">
            <MudText Typo="Typo.h6">Add Recurring</MudText>
            <MudTextField T="string"
                          @bind-Value="newRecurring.Description"
                          Label="Description"
                          FullWidth="true" />
            <MudStack Row AlignItems="AlignItems.Center"
                      Spacing="2"
                      Class="mt-2 flex-wrap">
                @foreach (var d in Enum.GetValues<DayOfWeek>())
                {
                    <MudCheckBox T="bool"
                                 @bind-Value="daySel[d]"
                                 Label="@d.ToString()[..3]" />
                }
            </MudStack>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="AddRecurring"
                       Class="mt-2">
                Add Recurring
            </MudButton>
        </MudPaper>

        <MudPaper Class="pa-4 mt-4" Elevation="0">
            <MudText Typo="Typo.h6">Add One-Off</MudText>
            <MudTextField T="string"
                          @bind-Value="newOneOff.Description"
                          Label="Description"
                          FullWidth="true" />
            <MudDatePicker T="DateTime?"
                           @bind-Date="newOneOff.Date"
                           Format="dd/MM/yyyy"
                           Class="mt-2" />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="AddOneOff"
                       Class="mt-2">
                Add One-Off
            </MudButton>
        </MudPaper>
    }
    else if (currentView == ViewType.List)
    {
        <MudDivider Class="my-4" />

        <MudText Typo="Typo.h6">Recurring Chore Definitions</MudText>
        <MudList T="RecurringChore" Dense="true">
            @foreach (var c in RecurringChores)
            {
                <MudListItem T="RecurringChore" Value="c" Text="@c.Description">
                    <MudSpacer />
                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                   OnClick="() => UpdateRecurring(c.Id)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   OnClick="() => DeleteRecurring(c.Id)" />
                </MudListItem>
            }
        </MudList>

        <MudText Typo="Typo.h6" Class="mt-4">One-Off Chore Definitions</MudText>
        <MudList T="OneOffChore" Dense="true">
            @foreach (var o in OneOffChores)
            {
                <MudListItem T="OneOffChore" Value="o" Text="@($"{o.Description} ({o.Date:dd/MM/yyyy})")">
                    <MudSpacer />
                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                   OnClick="() => UpdateOneOff(o.Id)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   OnClick="() => DeleteOneOff(o.Id)" />
                </MudListItem>
            }
        </MudList>
    }
</MudContainer>

@code {
    enum ViewType { Active, Add, List }
    private ViewType currentView = ViewType.Active;

    private List<RecurringChore> RecurringChores => ChoreService.RecurringChores;
    private List<OneOffChore> OneOffChores => ChoreService.OneOffChores;

    private RecurringChore newRecurring = new();
    private OneOffChore newOneOff = new() { Date = DateTime.Today };
    private Dictionary<DayOfWeek, bool> daySel =
        Enum.GetValues<DayOfWeek>().ToDictionary(d => d, _ => false);

    protected override async Task OnInitializedAsync()
        => await ChoreService.LoadTodayAsync();

    void ShowView(ViewType view) => currentView = view;
    async Task CompleteRecurring(Guid id) => await OnRecurringChecked(id);
    async Task CompleteOneOff(Guid id) => await OnOneOffChecked(id);

    void UpdateRecurring(Guid id) { /* TODO: open edit UI */ }
    void UpdateOneOff(Guid id) { /* TODO: open edit UI */ }

    async Task DeleteRecurring(Guid id)
    {
        await ChoreService.DeleteRecurringAsync(id);
        await ChoreService.LoadTodayAsync();
        currentView = ViewType.Active;
    }

    async Task DeleteOneOff(Guid id)
    {
        await ChoreService.DeleteOneOffAsync(id);
        await ChoreService.LoadTodayAsync();
        currentView = ViewType.Active;
    }

    private async Task OnRecurringChecked(Guid id)
    {
        RecurringChores.RemoveAll(c => c.Id == id);
        await ChoreService.CompleteRecurringAsync(id);
    }

    private async Task OnOneOffChecked(Guid id)
    {
        OneOffChores.RemoveAll(o => o.Id == id);
        await ChoreService.CompleteOneOffAsync(id);
    }

    private async Task AddRecurring()
    {
        newRecurring.Monday = daySel[DayOfWeek.Monday];
        newRecurring.Tuesday = daySel[DayOfWeek.Tuesday];
        newRecurring.Wednesday = daySel[DayOfWeek.Wednesday];
        newRecurring.Thursday = daySel[DayOfWeek.Thursday];
        newRecurring.Friday = daySel[DayOfWeek.Friday];
        newRecurring.Saturday = daySel[DayOfWeek.Saturday];
        newRecurring.Sunday = daySel[DayOfWeek.Sunday];

        await ChoreService.AddRecurringAsync(newRecurring);
        newRecurring = new();
        daySel = Enum.GetValues<DayOfWeek>()
                     .ToDictionary(d => d, _ => false);
        await ChoreService.LoadTodayAsync();
    }

    private async Task AddOneOff()
    {
        await ChoreService.AddOneOffAsync(newOneOff);
        newOneOff = new() { Date = DateTime.Today };
        await ChoreService.LoadTodayAsync();
    }
}
